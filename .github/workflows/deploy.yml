name: Lambda API to CSV Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  LAMBDA_FUNCTION_NAME: api-to-csv-function
  S3_BUCKET: your-output-bucket
  CFN_STACK_NAME: api-to-csv-prod

jobs:
  validate-cloudformation:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cfn-lint and checkov
        run: pip install cfn-lint checkov

      - name: Check Required Files Exist
        run: |
          echo "üîç Checking required files..."
          FILES=(
            "cloudformation/template.yml"
            "api_extractor/app_api_extractor.py"
            "csv_extractor/app_csv_extractor.py"
            "requirements.txt"
          )
          ALL_GOOD=true
          for FILE in "${FILES[@]}"; do
            if [ -f "$FILE" ]; then
              echo "‚úÖ Found: $FILE"
            else
              echo "‚ùå Missing: $FILE"
              ALL_GOOD=false
            fi
          done
          if [ "$ALL_GOOD" = false ]; then
            exit 1
          fi

      - name: Validate CFN Template (AWS CLI)
        run: |
          echo "üîç Validating CloudFormation template..."
          aws cloudformation validate-template \
            --template-body file://cloudformation/template.yml \
            --region ${{ env.AWS_REGION }}
          echo "‚úÖ Template passed AWS validation"

      - name: Lint CFN Template (cfn-lint)
        run: |
          echo "üîç Running cfn-lint..."
          cfn-lint cloudformation/template.yml || true

      - name: Security Scan (Checkov)
        run: |
          echo "üîí Running security scan with Checkov..."
          checkov \
            -d cloudformation/ \
            --framework cloudformation \
            --output cli \
            --soft-fail

      - name: Validate Stack Name Convention
        run: |
          python3 << 'EOF'
          import re, sys, os
          PATTERN = r'^[a-z][a-z0-9-]{2,}-(dev|qa|staging|prod)$'
          stack_name = os.environ.get("CFN_STACK_NAME", "")
          print(f"Stack name: {stack_name}")
          if not re.match(PATTERN, stack_name):
              print(f"‚ùå Stack name '{stack_name}' does not match pattern")
              sys.exit(1)
          print("‚úÖ Stack name convention passed!")
          EOF
        env:
          CFN_STACK_NAME: ${{ env.CFN_STACK_NAME }}

  deploy-lambda:
    name: Deploy Lambda
    runs-on: ubuntu-latest
    needs: validate-cloudformation
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ‚úÖ Package YOUR actual folders into lambda zip
      - name: Package Lambda Code
        run: |
          echo "üì¶ Installing dependencies..."
          pip install -r requirements.txt -t package/

          echo "üìÅ Copying your source files..."
          cp api_extractor/app_api_extractor.py package/
          cp csv_extractor/app_csv_extractor.py package/

          echo "üóúÔ∏è Creating zip..."
          cd package && zip -r ../function.zip .

          echo "‚úÖ Lambda packaged:"
          unzip -l ../function.zip

      - name: Deploy CloudFormation Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/template.yml \
            --stack-name ${{ env.CFN_STACK_NAME }} \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              Environment=prod \
              LambdaFunctionName=${{ env.LAMBDA_FUNCTION_NAME }} \
            --tags \
              Environment=prod \
              Owner=beastleohfslilly \
              Project=api-to-csv \
              CostCenter=engineering \
            --no-fail-on-empty-changeset

      - name: Upload Lambda Code
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://function.zip

      - name: Wait for Lambda Update
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }}

  invoke-and-download:
    name: Invoke Lambda & Get CSV
    runs-on: ubuntu-latest
    needs: deploy-lambda

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Invoke Lambda Function
        id: invoke
        run: |
          API_URL="https://api.open-meteo.com/v1/forecast?latitude=52.52&longitude=13.41&current_weather=true"

          aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --payload "{\"api_url\":\"$API_URL\",\"bucket\":\"${{ env.S3_BUCKET }}\"}" \
            --cli-binary-format raw-in-base64-out \
            response.json

          cat response.json

          S3_KEY=$(python3 -c "
          import json
          body = json.load(open('response.json'))
          print(json.loads(body['body'])['s3_key'])
          ")
          echo "s3_key=$S3_KEY" >> $GITHUB_OUTPUT

      - name: Download CSV from S3
        run: |
          mkdir -p output
          aws s3 cp s3://${{ env.S3_BUCKET }}/${{ steps.invoke.outputs.s3_key }} output/result.csv
          head -5 output/result.csv

      - name: Upload CSV as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: weather-output-csv
          path: output/result.csv
          retention-days: 30